name: CDK Pipeline

on:
  push:
    branches:
      - main

jobs:
  # build:
  #   runs-on: ubuntu-latest
    
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v3
  #     - uses: actions/setup-node@v2
  #       with:
  #         node-version: "16"

  #     - name: Install AWS CLI
  #       run: |
  #         if ! command -v aws &> /dev/null; then
  #           curl "https://d1vvhvl2y92vvt.cloudfront.net/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
  #           unzip awscliv2.zip
  #           sudo ./aws/install
  #         fi
  #         npm install -g aws-cdk
  #       if: success()

  #     - name: Configure AWS credentials
  #       run: |
  #         aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
  #         aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #         aws configure set aws_session_token ${{ secrets.AWS_SESSION_TOKEN }}
  #         aws configure set default.region us-east-1  # Change to your region
  #       if: success()

  #     - name: Synth CDK app to Dev
  #       run: cdk synth
  #       if: success()

  #     - name: Diff CDK app to Dev
  #       run: cdk diff
  #       if: success()

  #     - name: Deploy CDK app to Dev
  #       run: |
  #         cd ./
  #         cdk deploy
  #       if: success()

  promote-to-prod:
    # needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - uses: actions/setup-node@v2
        with:
          node-version: "16"
        
      - name: Install Dependencies
        run: |
          if ! command -v aws &> /dev/null; then
            curl "https://d1vvhvl2y92vvt.cloudfront.net/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip awscliv2.zip
            sudo ./aws/install
          fi
          npm install -g aws-cdk

          
      - name: Configure AWS credentials
        run: |
          aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws configure set aws_session_token ${{ secrets.AWS_SESSION_TOKEN }}
          aws configure set default.region us-east-1  # Change to your region

      - name: Synth CDK app to Prod
        run: cdk synth
        if: success()

      - name: Diff CDK app to Prod
        run: cdk diff
        if: success()

      - uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: vcarneiro-caylent
          minimun-approvals: 1
          ssue-title: "Deploying to production"
          issue-body: "Please approve or deny the deployment to production"
      
      - name: Deploy CDK app to Prod
        run: |
          if [ "$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ steps.manual-approval.outputs.issue-number }}/comments \
              | jq -r '.[].user.login')" == "vcarneiro-caylent" ]; then
            echo "Deployment to Prod approved. Proceeding with deployment..."
            # Add your deployment commands here
          else
            echo "Deployment to Prod not approved. Skipping..."
          fi
        if: success() && steps.manual-approval.outputs.approved == true